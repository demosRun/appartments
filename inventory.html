<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="apple-touch-icon" sizes="76x76"
        href="https://cunchu.site/work/material-dashboard/assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="https://cunchu.site/work/material-dashboard/assets/img/favicon.png">
    <title>
        酒店后台管理
    </title>

    <!-- CSS Files -->
    <link id="pagestyle" href="https://cunchu.site/work/material-dashboard/assets/css/material-dashboard.css?v=3.2.0"
        rel="stylesheet" />
    <style>
        .view-box .item {
            margin: 10px;
            float: left;
            width: 300px;
        }
    </style>
</head>

<body class="g-sidenav-show  bg-gray-100">
    <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
        <!-- Date picker -->
        <div class="container" style="height: 40px;">
            <div class="row" style=" display: flex; justify-content: end; ">
                <div class="col-md-2">
                    <div class="input-group input-group-static">
                        <input type="date" id="startDate" class="form-control input-item-1">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="input-group input-group-static">
                        <input type="date" id="endDate" class="form-control input-item-2">
                    </div>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn bg-gradient-info" onclick="search()">Search</button>
                </div>

            </div>
        </div>


        <div class="container-box container-fluid py-2">
            <div class="row">
                <div class="col-12">
                    <div class="view-box" id="viewBox"></div>

                </div>
            </div>
        </div>
        <!-- 分页 -->
        <nav aria-label="Page navigation example">
            <ul class="pagination">
            </ul>
        </nav>
        <!-- 弹出层 -->
        <div class="modal fade" id="modal-form" tabindex="-1" aria-labelledby="modal-form" style="display: none;"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
                <div class="modal-content">
                    <div class="modal-body p-0">
                        <div class="card card-plain">
                            <div class="card-header pb-0 text-left">
                                <h3 class="">Edit Room</h3>
                                <p id="modal-room-info" class="text-sm text-secondary mb-0"></p>
                            </div>
                            <div class="card-body">
                                <div class="col-md-12">
                                    <div class="input-group input-group-static">
                                        <label>Start Date (dd/mm/yyyy)</label>
                                        <input type="date" id="startDateC" class="form-control input-item-1">
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="input-group input-group-static">
                                        <label>End Date (dd/mm/yyyy)</label>
                                        <input type="date" id="endDateC" class="form-control input-item-1">
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="input-group input-group-static">
                                        <label>Room Price</label>
                                        <input type="number" id="roomP" class="form-control input-item-1">
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="input-group input-group-static">
                                        <label>Room Availability</label>
                                        <input type="number" id="roomN" class="form-control input-item-1">
                                    </div>
                                </div>
                                <button type="button" class="btn btn-primary btn-lg w-100" onclick="xgxx()">Update
                                    Info</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!--   Core JS Files   -->
    <script src="https://cunchu.site/work/material-dashboard/assets/js/core/bootstrap.min.js"></script>

    <script src="https://cunchu.site/puge/ws.js" type="text/javascript" charset="UTF-8"></script>
    <script>
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }
        function sendMessage(type, data) {
            window.parent.postMessage({ type: type, data: data }, '*');
        }
        const nowPage = getQueryParam('page') ? parseInt(getQueryParam('page')) : 1
        let wsOptions = {
            isAdmin: true
        }

        // Booking
        function creatCardBooking(meg) {
            let tempData = ``
            // Generate card
            if (!meg.value || !meg.value.list || !meg.value.rooms) {
                console.error("Invalid Booking inventory data:", meg);
                return;
            }

            // Clear viewBox if it's not empty
            if (window.viewBox.innerHTML.trim() !== '') {
                window.viewBox.innerHTML = '';
            }

            // Create cards for each room type
            meg.value.list.forEach(element => {
                const roomId = element[0];
                const roomName = element[1];
                tempData += createCommonCard(
                    "Booking",
                    {},
                    roomId,
                    roomName,
                    ""
                );
            });
            window.viewBox.innerHTML += tempData

            // Process each room to add daily rates
            for (const roomId in meg.value.rooms) {
                if (Object.prototype.hasOwnProperty.call(meg.value.rooms, roomId)) {
                    let tempData2 = ``
                    const roomData = meg.value.rooms[roomId];

                    // Find rate plans for this room
                    if (!roomData.rates || Object.keys(roomData.rates).length === 0) {
                        continue;
                    }

                    // Use the first rate plan (usually Standard Rate)
                    const rateIds = Object.keys(roomData.rates);
                    const rateId = rateIds[0]; // Use first rate plan
                    const rateData = roomData.rates[rateId];

                    // Get dates from the rate plan
                    if (!rateData.dates) {
                        continue;
                    }

                    // Sort dates chronologically
                    const dateList = Object.keys(rateData.dates).sort((a, b) => new Date(a) - new Date(b));

                    // Process each date
                    dateList.forEach(dateKey => {
                        const dateData = rateData.dates[dateKey];
                        // Get room availability from room data
                        const roomAvailability = roomData.dates && roomData.dates[dateKey] ?
                            roomData.dates[dateKey].rooms_to_sell : '0';

                        // Get price for the date - find first occupancy key
                        let price = '';
                        let occupancyKey = '';
                        if (dateData.price) {
                            occupancyKey = Object.keys(dateData.price)[0];
                            price = dateData.price[occupancyKey];
                        }

                        // Create list item with date, availability, price
                        tempData2 += createCommonListItem(
                            dateKey, // Date in YYYY-MM-DD format
                            roomAvailability, // Available rooms
                            price, // Price for the date and occupancy
                            dateData.status, // Status (bookable, closed, etc.)
                            `xgjg(${price}, '${roomId}', '${rateId}', '${dateKey}', '${dateKey}', '${occupancyKey}', ${roomAvailability})`
                        );
                    });

                    // Add the date list to the room card
                    setTimeout(() => {
                        const listContainer = document.querySelector('.list-group-' + roomId);
                        if (listContainer) {
                            listContainer.innerHTML = tempData2;
                        }
                    }, 0);
                }
            }
        }

        // Ctrip
        // function creatCardCtrip(meg) {
        //     let tempData = ``
        //     // Generate card
        //     for (const key in meg.value.roomTypeInfo) {
        //         if (Object.prototype.hasOwnProperty.call(meg.value.roomTypeInfo, key)) {
        //             const element = meg.value.roomTypeInfo[key];
        //             tempData += createCommonCard(
        //                 "Ctrip",
        //                 element,
        //                 element.id,
        //                 element.name,
        //                 ""
        //             );
        //             // Get room price detail
        //             window.cipher = meg.value.cipher
        //             sendMessage('queryRoomTypeDetail', {
        //                 page: nowPage - 1,
        //                 productId: element.productIds[0],
        //                 roomTypeId: element.id,
        //                 ebooking: window.ctripID,
        //                 cipher: meg.value.cipher,
        //                 start: window.startDate.value.replaceAll('-', ''),
        //                 end: window.endDate.value.replaceAll('-', ''),
        //             })
        //         }
        //     }
        //     window.viewBox.innerHTML += tempData
        // }

        // Common function to create cards for any platform
        function createCommonCard(platformName, roomData, roomId, roomName, listItems) {
            return `
            <div class="item">
                <div class="card h-100">
                    <div class="card-header pb-0 p-3">
                        <div class="row">
                            <div class="col-12 d-flex align-items-center">
                                <h6 class="mb-0">${platformName}:${roomName}</h6>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-3 pb-0">
                        <ul class="list-group list-group-${roomId}">
                            ${listItems}
                        </ul>
                    </div>
                </div>
            </div>`;
        }

        // Common function to create list items 
        function createCommonListItem(date, roomQty, price, status, editBtnOnClick, isPriceMinimum = false) {
            const priceDisplay = isPriceMinimum ?
                `<span class="text-xs text-warning" title="Minimum rate (actual rate not set)">${price} (min)</span>` :
                `<span class="text-xs">${price}</span>`;

            return `
            <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-0 border-radius-lg">
                <div class="d-flex flex-column">
                    <h6 class="mb-1 text-dark font-weight-bold text-sm">${date}（${roomQty}）</h6>
                    ${priceDisplay}
                </div>
                <div class="d-flex align-items-center text-sm">
                    ${status || ''}
                    <button type="button" class="btn btn-link text-dark text-sm mb-0 px-0 ms-4" data-bs-toggle="modal" data-bs-target="#modal-form" onclick="${editBtnOnClick}">
                        Edit
                    </button>
                </div>
            </li>`;
        }

        // Agoda
        function creatAgodaHotelCtrip(meg) {
            let tempData = ``
            let liData = {}
            // Filter the first price type
            if (!meg.value.RateList) {
                console.error(meg.value)
                return
            }
            const filtered = meg.value.RateList.filter(item => item.RateCategoryID === meg.value.RatePlanList[0].RateCategoryID);
            for (let index = 0; index < filtered.length; index++) {
                const element = filtered[index];
                if (!liData[element.RoomTypeID]) liData[element.RoomTypeID] = ""
                liData[element.RoomTypeID] += createCommonListItem(
                    element.Date,
                    meg.value.AllotmentList[index].Regular,
                    element.BasePrice,
                    element.DeviationType,
                    `xgjg3('${element.BasePrice}', '${element.RoomTypeID}', '${element.Date}', '${element.Date}', 2, '${meg.value.AllotmentList[index].Regular}', '${element.RateCategoryID}')`
                );
            }
            // Generate card
            for (const key in meg.value.Rooms) {
                if (Object.prototype.hasOwnProperty.call(meg.value.Rooms, key)) {
                    const element = meg.value.Rooms[key];
                    tempData += createCommonCard(
                        "Agoda",
                        element,
                        element.RoomTypeID,
                        element.RoomTypeName,
                        liData[element.RoomTypeID] || ''
                    );
                }
            }
            window.viewBox.innerHTML += tempData
        }

        function creatAgodaHomes(meg) {
            let tempData = ``
            let liData = ``
            for (let index = 0; index < meg.value.calendarDayInfos.length; index++) {
                const element = meg.value.calendarDayInfos[index];
                liData += createCommonListItem(
                    element.date.split('T')[0],
                    element.allotmentValue,
                    element.baseRate,
                    '',
                    `xgjg4('${element.date.split('T')[0]}', '${element.date.split('T')[0]}', '${element.baseRate}', '${meg.value.AgodaHomesID}')`
                );
            }
            // Generate card
            tempData += createCommonCard(
                "Agoda Homes upc",
                null,
                meg.value.AgodaHomesID,
                meg.value.AgodaHomesID,
                liData
            );
            window.viewBox.innerHTML += tempData
        }
        // Traverse to get price
        function findRoomPriceInfo(obj, results = []) {
            if (typeof obj === 'object' && obj !== null) {
                for (let key in obj) {
                    if (key === 'roomPriceInfo') {
                        results.push(obj[key].price);
                    } else {
                        findRoomPriceInfo(obj[key], results);
                    }
                }
            }
            return results;
        }
        function queryRoomTypeDetailCtrip(meg) {
            let tempData2 = ``
            for (const datesKey in meg.value.rangData) {
                if (Object.prototype.hasOwnProperty.call(meg.value.rangData, datesKey)) {
                    const element = meg.value.rangData[datesKey];
                    let personNum = 2
                    const IDlist = Object.keys(element.product)
                    if (element.product[IDlist[0]].person) {
                        personNum = Object.keys(element.product[IDlist[0]].person)[0]
                    }
                    // console.log(element, Object.keys(element.product)[0])
                    tempData2 += createCommonListItem(
                        datesKey,
                        element.roomToSell.value,
                        findRoomPriceInfo(element.product),
                        element.roomToSell.freeSale,
                        `xgjg2(${findRoomPriceInfo(element.product)}, '${IDlist[0]}', ${element.basicRoomQuantityInfo.basicRoomId}, '${datesKey}', '${datesKey}', ${personNum}, ${element.roomToSell.value})`
                    );
                }
            }
            setTimeout(() => {
                document.querySelector('.list-group-' + meg.value.roomTypeId).innerHTML = tempData2
            }, 0);
        }


        // Expedia 
        function creatExpedia(meg) {
            if (!meg.value || !meg.value.ratesRestrictionsAndInventory || !meg.value.ratesRestrictionsAndInventory.ratePlanMap) {
                console.error("Invalid Expedia data format:", meg);
                return;
            }

            const ratePlanMap = meg.value.ratesRestrictionsAndInventory.ratePlanMap;
            const dateRange = meg.value.dateRange;
            const roomMap = meg.value.roomMap || {};
            let tempData = "";
            
            // Initialize a global map to store rate plan names
            window.expediaRatePlans = window.expediaRatePlans || {};
            
            // Log room map for debugging purposes
            console.log("Room map from response:", roomMap);

            // Group rate plans by room type for better organization
            const roomTypeGroups = {};

            // First pass: organize rate plans by room type and identify child rate plans
            for (const ratePlanId in ratePlanMap) {
                if (Object.prototype.hasOwnProperty.call(ratePlanMap, ratePlanId)) {
                    const ratePlan = ratePlanMap[ratePlanId];
                    
                    // Get room information from linkage tree
                    let roomTypeId = null;
                    let roomTypeName = "Standard Room";
                    
                    if (ratePlan && ratePlan.linkageTree && ratePlan.linkageTree.rootRatePlan) {
                        roomTypeName = ratePlan.linkageTree.rootRatePlan.associatedRoomTypeName || roomTypeName;
                        
                        // Look for the roomTypeId in all available child rate plans first
                        if (ratePlan.linkageTree.rootRatePlan.childRatePlans && ratePlan.linkageTree.rootRatePlan.childRatePlans.length > 0) {
                            // Try to find any associatedRoomTypeId in the child rate plans
                            for (const childPlan of ratePlan.linkageTree.rootRatePlan.childRatePlans) {
                                if (childPlan && childPlan.associatedRoomTypeId) {
                                    roomTypeId = childPlan.associatedRoomTypeId;
                                    break;
                                }
                            }
                        }
                        
                        // If still not found, try the root rate plan
                        if (!roomTypeId && ratePlan.linkageTree.rootRatePlan.associatedRoomTypeId) {
                            roomTypeId = ratePlan.linkageTree.rootRatePlan.associatedRoomTypeId;
                        }
                    }
                    
                    // If we couldn't get the roomTypeId directly, check if we can get it from the roomMap
                    // The roomMap keys are the actual room type IDs we need for inventory updates (e.g., 325697395)
                    if (!roomTypeId) {
                        // Find a roomMap entry that corresponds to this rate plan's room
                        for (const mapRoomTypeId in roomMap) {
                            if (roomMap[mapRoomTypeId].roomTypeData && 
                                roomMap[mapRoomTypeId].roomTypeData.name === roomTypeName) {
                                roomTypeId = mapRoomTypeId;
                                break;
                            }
                        }
                    }
                    
                    // If still not found, try to infer it from rate and restriction data
                    if (!roomTypeId) {
                        // Look for any date entry that might contain the roomTypeId
                        const firstDateKey = Object.keys(ratePlan.rateAndRestrictionByDate)[0];
                        if (firstDateKey && ratePlan.rateAndRestrictionByDate[firstDateKey][0]) {
                            const firstDateData = ratePlan.rateAndRestrictionByDate[firstDateKey][0];
                            if (firstDateData.roomTypeId) {
                                roomTypeId = firstDateData.roomTypeId;
                            }
                        }
                    }

                    // If we still don't have a roomTypeId, use the ratePlanId as a fallback
                    roomTypeId = roomTypeId || ratePlanId;
                    
                    // Initialize group if needed
                    if (!roomTypeGroups[roomTypeId]) {
                        roomTypeGroups[roomTypeId] = {
                            roomTypeId: roomTypeId,
                            roomTypeName: roomTypeName,
                            ratePlans: []
                        };
                    }
                    
                    // Find if this is a child rate plan
                    let isChildRatePlan = false;
                    let parentRatePlanId = null;
                    let planNameWithType = null;
                    
                    // Check if this rate plan is a child rate plan in any other plan's linkage tree
                    for (const otherRatePlanId in ratePlanMap) {
                        const otherRatePlan = ratePlanMap[otherRatePlanId];
                        if (otherRatePlan && otherRatePlan.linkageTree && otherRatePlan.linkageTree.rootRatePlan && otherRatePlan.linkageTree.rootRatePlan.childRatePlans) {
                            const childPlans = otherRatePlan.linkageTree.rootRatePlan.childRatePlans;
                            const foundChildPlan = childPlans.find(child => child && (child.ratePlanId === Number(ratePlanId) || child.ratePlanId === ratePlanId));
                            
                            if (foundChildPlan) {
                                isChildRatePlan = true;
                                parentRatePlanId = otherRatePlanId;
                                planNameWithType = foundChildPlan.ratePlanNameWithType || foundChildPlan.ratePlanNameWithTypeAndAdjustment || null;
                                break;
                            }
                        }
                    }
                    
                    // If not a child plan, check if it's a root plan with its own name
                    if (!isChildRatePlan && ratePlan && ratePlan.linkageTree && ratePlan.linkageTree.rootRatePlan) {
                        planNameWithType = ratePlan.linkageTree.rootRatePlan.ratePlanNameWithType || null;
                    }
                    
                    // Store the rate plan name for later use in updates
                    if (planNameWithType) {
                        window.expediaRatePlans[ratePlanId] = planNameWithType;
                    }
                    
                    // Add rate plan to the group
                    roomTypeGroups[roomTypeId].ratePlans.push({
                        ratePlanId: ratePlanId,
                        ratePlan: ratePlan,
                        isChildRatePlan: isChildRatePlan,
                        parentRatePlanId: parentRatePlanId,
                        planNameWithType: planNameWithType
                    });
                }
            }

            // Second pass: create cards for each room type with its rate plans
            for (const roomTypeId in roomTypeGroups) {
                if (Object.prototype.hasOwnProperty.call(roomTypeGroups, roomTypeId)) {
                    const group = roomTypeGroups[roomTypeId];
                    const roomInventory = roomMap[roomTypeId] || {};
                    
                    // Process each rate plan in this room type
                    group.ratePlans.forEach(({ratePlanId, ratePlan, isChildRatePlan, parentRatePlanId, planNameWithType}) => {
                        let liData = "";
                        
                        // Use the planNameWithType from childRatePlans or fallback
                        let ratePlanName = planNameWithType || "Standard Rate";
                        
                        // Get all dates from the rate plan
                        const dates = Object.keys(ratePlan.rateAndRestrictionByDate).sort();
                        
                        // Process each date
                        dates.forEach(dateStr => {
                            const dateData = ratePlan.rateAndRestrictionByDate[dateStr];
                            if (!dateData || !dateData[0]) return;
                            
                            const rateInfo = dateData[0];
                            const isRoomBookable = rateInfo.isRoomTypeBookable ? "Bookable" : "Closed";
                            
                            // Get price information
                            let price = 0;
                            if (rateInfo.rateInformation && rateInfo.rateInformation.length > 0) {
                                price = rateInfo.rateInformation[0].amount;
                            }
                            
                            // Get inventory information
                            let roomToSell = 0;
                            // Check if we have inventory data for this room and date
                            if (roomInventory.inventoryDateMap && roomInventory.inventoryDateMap[dateStr]) {
                                const inventoryInfo = roomInventory.inventoryDateMap[dateStr].inventoryInformationModel;
                                if (inventoryInfo) {
                                    roomToSell = inventoryInfo.inventoryAvailable || 0;
                                }
                            } else if (!rateInfo.isZeroInventory) {
                                roomToSell = 10; // Default value when inventory isn't available
                            }
                            
                            // Create list item for this date, making sure to pass the actual roomTypeId from roomMap
                            liData += createCommonListItem(
                                dateStr,
                                roomToSell,
                                price,
                                isRoomBookable,
                                `xgjg5('${dateStr}', '${ratePlanId}', ${price}, ${roomToSell}, '${roomTypeId}', '${group.roomTypeName.replace(/'/g, "\\'")}')`
                            );
                        });
                        
                        // Create card with the rate plan information, using the proper plan name
                        tempData += createCommonCard(
                            "Expedia",
                            ratePlan,
                            `${roomTypeId}-${ratePlanId}`,
                            `${group.roomTypeName} - ${ratePlanName} (Room ID: ${roomTypeId})`,
                            liData
                        );
                    });
                }
            }

            window.viewBox.innerHTML += tempData;
        }

        // Format date for Agoda API in yyyy-MM-dd format
        function formatDateForAgodaAPI(dateStr) {
            // Make sure we have a valid date string in YYYY-MM-DD format
            if (!dateStr || typeof dateStr !== 'string' || !dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                console.error("Invalid date format:", dateStr);
                return null;
            }

            // Return the date in YYYY-MM-DD format without any transformation
            return dateStr;
        }

        // Format date for DD-MM-YYYY format (used in API URL)
        function formatDateForAgodaURL(dateStr) {
            if (!dateStr || typeof dateStr !== 'string' || !dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                console.error("Invalid date format for URL:", dateStr);
                return null;
            }

            // Convert from YYYY-MM-DD to DD-MM-YYYY
            const parts = dateStr.split('-');
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }

        // Create list items for Agoda Hotel specifically
        function createAgodaListItem(date, roomQty, price, status, roomId, hotelId, dmcId, ratePlanId, maxGuests, usingMinimumRate = false) {
            const priceDisplay = usingMinimumRate ?
                `<span class="text-xs text-warning" title="Minimum rate (actual rate not set)">${price} (min)</span>` :
                `<span class="text-xs">${price}</span>`;

            return `
            <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-0 border-radius-lg">
                <div class="d-flex flex-column">
                    <h6 class="mb-1 text-dark font-weight-bold text-sm">${date}（${roomQty}）</h6>
                    ${priceDisplay}
                </div>
                <div class="d-flex align-items-center text-sm">
                    ${status || ''}
                    <button type="button" class="btn btn-link text-dark text-sm mb-0 px-0 ms-4" 
                            data-bs-toggle="modal" 
                            data-bs-target="#modal-form" 
                            onclick="xgjg6('${date}', '${roomId}', ${price}, ${roomQty}, '${hotelId}', ${dmcId}, '${ratePlanId}', '${maxGuests}')">
                        Edit
                    </button>
                </div>
            </li>`;
        }

        // Create Agoda Hotel card from availability data
        function createAgodaHotelAvailability(meg) {
            if (!meg.value || !meg.value.data) {
                console.error("Invalid Agoda Hotel data format", meg);
                return;
            }

            // Store currency information from the response
            window.AgodaCurrency = meg.value.data.currency || "VND";

            let tempData = "";

            // Create a mapping of roomIds to their corresponding room objects for easy lookup
            const roomsMap = {};
            if (meg.value.data.availability && Array.isArray(meg.value.data.availability)) {
                meg.value.data.availability.forEach(room => {
                    roomsMap[room.roomId] = room;
                });
            }



            // Keep track of processed room-rate combinations
            const processedCombinations = new Set();

            // Process each rate plan directly - avoid the intermediate roomsById mapping
            if (meg.value.data.rates && Array.isArray(meg.value.data.rates)) {
                meg.value.data.rates.forEach(ratePlan => {
                    // Only process if we have a valid roomId and can find the room data
                    if (!ratePlan.roomId || !roomsMap[ratePlan.roomId]) {
                        return;
                    }

                    // Get the room data
                    const room = roomsMap[ratePlan.roomId];

                    // Generate a unique identifier for this room-rate combination
                    const combinationKey = `${room.roomId}-${ratePlan.ratePlanId}`;

                    // Skip if we've already processed this exact combination
                    if (processedCombinations.has(combinationKey)) {
                        return;
                    }

                    // Mark this combination as processed
                    processedCombinations.add(combinationKey);

                    let liData = "";

                    // Skip if there's no data for this room
                    if (!room.days || !Array.isArray(room.days) || room.days.length === 0) {
                        return;
                    }

                    // Sort days by date
                    const sortedDays = [...room.days].sort((a, b) =>
                        new Date(a.date) - new Date(b.date)
                    );

                    // Generate list items for each date
                    sortedDays.forEach(day => {
                        const dateStr = day.date.split('T')[0];
                        const roomsAvailable = day.remainingRoomNightsAvailable;
                        const status = day.isClosedOut ? "Closed" : "Bookable";

                        // Find rate for this room and rate plan on this date
                        let price = 0;
                        let usingMinimumRate = false;

                        // Find the rate for this specific day in this rate plan
                        const dayRate = ratePlan.rateByDays.find(rateDay =>
                            rateDay.date === day.date
                        );

                        if (dayRate && dayRate.occupancyRate) {
                            // Get the first occupancy rate (usually for 1 person)
                            const firstOccupancy = Object.keys(dayRate.occupancyRate)[0];
                            price = dayRate.occupancyRate[firstOccupancy];
                        } else {
                            price = ratePlan.minimumRate || 0;
                            usingMinimumRate = true;
                        }

                        // Use the specialized Agoda list item creator 
                        liData += createAgodaListItem(
                            dateStr,
                            roomsAvailable,
                            price,
                            status,
                            room.roomId,
                            day.hotelId,
                            day.dmcId,
                            ratePlan.ratePlanId,
                            ratePlan.noOfMaximumGuests,
                            usingMinimumRate
                        );
                    });

                    // Create card with full information about the room and rate plan
                    tempData += createCommonCard(
                        `Agoda Hotel ${room.days[0].hotelId}: ${ratePlan.ratePlanName || "Default Rate"}`,
                        room,
                        combinationKey, // Unique ID for the list group
                        `${room.roomName} (Rate: ${ratePlan.ratePlanName}, Max Guests: ${ratePlan.noOfMaximumGuests})`,
                        liData
                    );
                });
            }

            window.viewBox.innerHTML += tempData;
        }

        // Display Ctrip room availability 
        function displayCtripAvailability(meg) {
            if (!meg.value || !meg.value.availability || !meg.value.roomTypeInfo) {
                console.error("Invalid Ctrip data format:", meg);
                return;
            }

            const roomTypeData = meg.value.roomTypeInfo;
            const availability = meg.value.availability;
            const roomTypeId = meg.value.roomTypeId;
            const roomTypeName = meg.value.roomTypeName;
            const cipher = meg.value.cipher || {};

            // Store cipher data for later use
            window.ctripCipherData = cipher;

            let tempData = "";
            let liData = "";

            // Check if we have rangData which contains the daily availability
            if (availability.rangData) {
                // Get dates from rangList and sort them
                const dates = Array.isArray(availability.rangList) ?
                    [...availability.rangList].sort() :
                    Object.keys(availability.rangData).sort();

                // Process each date
                dates.forEach(dateStr => {
                    if (!availability.rangData[dateStr]) return;

                    const dateData = availability.rangData[dateStr];

                    // Get room availability info
                    const roomToSell = dateData.roomToSell && dateData.roomToSell.value !== undefined ?
                        dateData.roomToSell.value :
                        (dateData.basicRoomQuantityInfo ? dateData.basicRoomQuantityInfo.canUsedQuantity : 0);

                    // Format date from YYYYMMDD to YYYY-MM-DD for display
                    const formattedDate = dateStr.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');

                    // Get product information (first product is used as an example)
                    const productIds = Object.keys(dateData.product || {});
                    if (productIds.length === 0) return;

                    const productId = productIds[0];
                    const productData = dateData.product[productId];

                    // Extract basic room ID
                    const basicRoomId = dateData.basicRoomQuantityInfo ?
                        dateData.basicRoomQuantityInfo.basicRoomId : roomTypeId;

                    // Get price info - check for person data which contains prices
                    let price = 0;
                    let personNum = 0;

                    if (productData.person) {
                        const persons = Object.keys(productData.person);
                        if (persons.length > 0) {
                            personNum = persons[0];
                            const personData = productData.person[personNum];
                            if (personData && personData.roomPriceInfo) {
                                price = personData.roomPriceInfo.price;
                            } else if (personData && personData.value) {
                                price = personData.value;
                            }
                        }
                    }

                    // Get booking status
                    const status = productData.roomStatus ?
                        (productData.roomStatus.value === 1 ? "Bookable" : "Closed") :
                        (dateData.roomToSell && dateData.roomToSell.instanctConfirm ? "Bookable" : "On Request");

                    // Create list item - properly escape the room name for JavaScript
                    liData += createCommonListItem(
                        formattedDate,
                        roomToSell,
                        price,
                        status,
                        `xgjg2(${price}, '${productId}', ${basicRoomId}, '${dateStr}', '${dateStr}', ${personNum}, ${roomToSell}, '${roomTypeName.replace(/'/g, "\\'")}')`
                    );
                });

                // Create card with the room information
                tempData = createCommonCard(
                    `Ctrip ${roomTypeId}`,
                    roomTypeData,
                    roomTypeId,
                    roomTypeName,
                    liData
                );

                window.viewBox.innerHTML += tempData;
            }
        }

        window.addEventListener('message', function (event) {
            const meg = event.data
            console.log(meg)
            switch (meg.type) {
                case "inventory":
                    creatCardBooking(meg)
                    break;
                case "inventoryCtrip":
                    creatCardCtrip(meg)
                    break;
                case "inventoryAgodaHotel":
                    creatAgodaHotelCtrip(meg)
                    break;
                case "availabilityHubViewModel":
                    createAgodaHotelAvailability(meg)
                    break;
                case "inventoryAgodaHomes":
                    creatAgodaHomes(meg)
                    break;
                // case "inventoryExped
                case "ratesAndAvailabilityExpedia":
                    creatExpedia(meg)
                    break;
                case "inventoryBooking":
                    creatCardBooking(meg)
                    break;
                case "updatePriceCallBack":
                    if (meg.value && typeof meg.value === 'object') {
                        const status = meg.value.isSuccess !== false;
                        const message = meg.value.message || (status ? 'Update successful' : 'Update failed');

                        // Show a message with the update result
                        const messageDiv = document.createElement('div');
                        messageDiv.className = status ? 'alert alert-success' : 'alert alert-danger';
                        messageDiv.style.position = 'fixed';
                        messageDiv.style.top = '20px';
                        messageDiv.style.left = '50%';
                        messageDiv.style.transform = 'translateX(-50%)';
                        messageDiv.style.zIndex = '9999';
                        messageDiv.innerHTML = message;
                        document.body.appendChild(messageDiv);

                        // Remove the message after 3 seconds
                        setTimeout(() => {
                            document.body.removeChild(messageDiv);
                            // Reload the page if the update was successful
                            if (status) {
                                location.reload();
                            }
                        }, 3000);
                    } else {
                        location.reload();
                    }
                    break;
                case "queryRoomTypeDetailCtrip":
                    queryRoomTypeDetailCtrip(meg)
                    break;
                case "displayCtripAvailability":
                    displayCtripAvailability(meg)
                    break;
                default:
                    break;
            }
        })


        function search() {
            location.href = `./inventory.html?hotelID=${getQueryParam('hotelID')}&start=${window.startDate.value}&end=${window.endDate.value}`
        }
        function getDateNDaysAgo(n) {
            const date = new Date();
            date.setDate(date.getDate() + n); // Get the date N days ago

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0"); // The month starts from 0, so add 1
            const day = String(date.getDate()).padStart(2, "0");

            return `${year}-${month}-${day}`;
        }
        if (getQueryParam('start')) window.startDate.value = getQueryParam('start')
        else window.startDate.value = getDateNDaysAgo(0)

        if (getQueryParam('end')) window.endDate.value = getQueryParam('end')
        else window.endDate.value = getDateNDaysAgo(31)


        function xgjg(oldPrice, room_id, rate_id, from_date, until_date, occupancy, roomNum) {
            window.startDateC.value = from_date
            window.endDateC.value = until_date
            window.roomP.value = oldPrice
            window.roomN.value = roomNum
            window.room_id = room_id
            window.rate_id = rate_id
            window.occupancy = occupancy
            document.querySelector('#modal-form .card-header h3').textContent = "Edit Booking Room"
            document.querySelector('#modal-room-info').textContent = `Room ID: ${room_id}, Rate ID: ${rate_id}, Occupancy: ${occupancy}`
        }
        function xgjg2(oldPrice, room_id, basicRoomId, from_date, until_date, person, roomNum, roomName) {
            // Format dates from YYYYMMDD to YYYY-MM-DD if needed
            const formattedFromDate = from_date.includes('-') ? from_date : from_date.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
            const formattedUntilDate = until_date.includes('-') ? until_date : until_date.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');

            window.startDateC.value = formattedFromDate;
            window.endDateC.value = formattedUntilDate;
            window.roomP.value = oldPrice;
            window.room_id_ctrip = room_id;
            window.roomN.value = roomNum;
            window.basicRoomId = basicRoomId;
            window.person = person;

            // Store the cipher from the earlier API response for use in the update
            window.roomCipher = window.ctripCipherData;

            document.querySelector('#modal-form .card-header h3').textContent = "Edit Ctrip Room";
            document.querySelector('#modal-room-info').textContent = `Room ID: ${room_id}, Basic Room ID: ${basicRoomId}, Person: ${person}, Room Name: ${roomName}`;
        }
        function xgjg3(oldPrice, RoomTypeID, StartDateStr, EndDateStr, person, Regular, RateCategoryID) {
            window.startDateC.value = StartDateStr
            window.endDateC.value = EndDateStr
            window.roomP.value = oldPrice
            window.roomN.value = Regular
            window.RoomTypeID = RoomTypeID
            window.RateCategoryID = RateCategoryID
            document.querySelector('#modal-form .card-header h3').textContent = "Edit Agoda Hotel Room"
            document.querySelector('#modal-room-info').textContent = `Room Type ID: ${RoomTypeID}, Rate Category: ${RateCategoryID}`
        }
        function xgjg4(StartDateStr, EndDateStr, oldPrice, room_id) {
            window.startDateC.value = StartDateStr
            window.endDateC.value = EndDateStr
            window.roomP.value = oldPrice
            window.roomN.value = 2
            window.AgodaHomeslID = room_id
            document.querySelector('#modal-form .card-header h3').textContent = "Edit Agoda Homes Room"
            document.querySelector('#modal-room-info').textContent = `Agoda Homes ID: ${room_id}`
        }
        function xgjg5(StartDateStr, ratePlanId, oldPrice, roomNum, roomID, roomTypeName) {
            window.startDateC.value = StartDateStr
            window.endDateC.value = StartDateStr
            window.roomP.value = oldPrice
            window.roomN.value = roomNum
            window.ExpediapID = ratePlanId
            window.roomID = roomID  // This is the actual roomID from inventory.json (e.g., 325697395)
            window.roomTypeName = roomTypeName
            
            // Find the corresponding rate plan name if available
            let ratePlanName = "Standard Rate";
            if (window.expediaRatePlans && window.expediaRatePlans[ratePlanId]) {
                ratePlanName = window.expediaRatePlans[ratePlanId];
            }
            window.ratePlanName = ratePlanName;
            
            document.querySelector('#modal-form .card-header h3').textContent = "Edit Expedia Room"
            document.querySelector('#modal-room-info').textContent = `Rate Plan ID: ${ratePlanId}, Room ID: ${roomID}, Type: ${roomTypeName}`
        }
        function xgjg6(dateStr, roomId, price, roomNum, hotelId, dmcId, ratePlanId, maxGuests) {
            console.log("xgjg6 parameters:", {
                dateStr, roomId, price, roomNum, hotelId, dmcId, ratePlanId, maxGuests
            });

            window.startDateC.value = dateStr;
            window.endDateC.value = dateStr;
            window.roomP.value = price;
            window.roomN.value = roomNum;
            window.AgodaHotelRoomID = roomId;
            window.AgodaHotelID = hotelId;
            window.AgodaDmcId = dmcId;
            window.AgodaRatePlanId = ratePlanId;
            window.AgodaMaxGuests = maxGuests;
            // Store the original date format for API call
            window.AgodaDateFormat = dateStr;

            document.querySelector('#modal-form .card-header h3').textContent = "Edit Agoda Hotel Availability";
            document.querySelector('#modal-room-info').textContent =
                `Room ID: ${roomId}, Rate Plan: ${ratePlanId}, Max Guests: ${maxGuests}, Hotel ID: ${hotelId}, DMC ID: ${dmcId}`;
        }
        function xgxx() {
            let cipher = window.roomCipher || {};
            if (window.cipher && window.room_id_ctrip) {
                cipher[window.room_id_ctrip] = window.cipher[window.room_id_ctrip];
                cipher[window.basicRoomId] = window.cipher[window.basicRoomId];
            }

            // If we're editing Agoda Hotel data
            if (window.AgodaHotelRoomID && window.AgodaDmcId) {
                // Format the dates properly for the Agoda API
                const formattedStartDate = formatDateForAgodaAPI(window.startDateC.value);
                const formattedEndDate = formatDateForAgodaAPI(window.endDateC.value);

                // Check if dates are valid before proceeding
                if (!formattedStartDate || !formattedEndDate) {
                    alert("Invalid date format. Please check your dates.");
                    return;
                }

                // Get dates in DD-MM-YYYY format for the API URLs
                const startDateFormatted = formatDateForAgodaURL(formattedStartDate);
                const endDateFormatted = formatDateForAgodaURL(formattedEndDate);

                // Format request according to the expected structure
                const request = {
                    priceConfig: {
                        hotelId: window.AgodaHotelID,
                        roomTypeId: window.AgodaHotelRoomID,
                        dateFrom: formattedStartDate,
                        dateTo: formattedEndDate,
                        // Pre-formatted dates for the API URLs
                        startDateFormatted: startDateFormatted,
                        endDateFormatted: endDateFormatted,
                        price: window.roomP.value,
                        dmcId: parseInt(window.AgodaDmcId),
                        currency: window.AgodaCurrency || "VND",
                        ratePlanId: window.AgodaRatePlanId,
                        maxGuests: window.AgodaMaxGuests,
                        // Additional parameters needed by updatePriceAgoda
                        basePrice: window.roomP.value,
                        // Use ISO format for dates (YYYY-MM-DD)
                        startDate: formattedStartDate,
                        endDate: formattedEndDate
                    },
                    availabilityConfig: {
                        roomId: window.AgodaHotelRoomID, // roomId is used in updateAvailabilityAgoda
                        startDateFormatted: startDateFormatted,
                        endDateFormatted: endDateFormatted,
                        totalAvailability: window.roomN.value, // totalAvailability is used in updateAvailabilityAgoda
                        hotelId: window.AgodaHotelID,

                        roomTypeId: window.AgodaHotelRoomID,
                        dateFrom: formattedStartDate,
                        dateTo: formattedEndDate,
                        roomsToSell: window.roomN.value,
                        dmcId: parseInt(window.AgodaDmcId),
                        // Use ISO format for dates (YYYY-MM-DD)
                        startDate: formattedStartDate,
                        endDate: formattedEndDate
                    }
                };

                console.log("Sending update request:", request);
                sendMessage('updateAgodaRateAndAvailability', request);

                // Close the modal after sending the request
                const modalElement = document.getElementById('modal-form');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }

                // Add a temporary success message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'alert alert-success';
                messageDiv.style.position = 'fixed';
                messageDiv.style.top = '20px';
                messageDiv.style.left = '50%';
                messageDiv.style.transform = 'translateX(-50%)';
                messageDiv.style.zIndex = '9999';
                messageDiv.innerHTML = `Updating Agoda Hotel data for Room ${window.AgodaHotelRoomID}, Rate Plan ${window.AgodaRatePlanId}, Date ${formattedStartDate} to ${formattedEndDate}...`;
                document.body.appendChild(messageDiv);

                // Remove the message after 3 seconds
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 3000);

                return;
            }

            // If we're editing Ctrip room data
            if (window.room_id_ctrip && window.basicRoomId) {
                // Format request for Ctrip room update
                const request = {
                    hotelId: window.ctripID,
                    basicRoomId: window.basicRoomId,
                    roomId: window.room_id_ctrip,
                    startDate: window.startDateC.value,
                    endDate: window.endDateC.value,
                    price: window.roomP.value,
                    person: window.person || 2,
                    roomNum: window.roomN.value,
                    cipher: cipher,
                    productOperateType: "CALENDAR_MODAL"
                };

                console.log("Sending Ctrip update request:", request);
                sendMessage('updateCtripRoom', request);

                // Close the modal after sending the request
                const modalElement = document.getElementById('modal-form');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }

                // Add a temporary success message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'alert alert-info';
                messageDiv.style.position = 'fixed';
                messageDiv.style.top = '20px';
                messageDiv.style.left = '50%';
                messageDiv.style.transform = 'translateX(-50%)';
                messageDiv.style.zIndex = '9999';
                messageDiv.innerHTML = `Updating Ctrip room ${window.room_id_ctrip} from ${window.startDateC.value} to ${window.endDateC.value}...`;
                document.body.appendChild(messageDiv);

                // Remove the message after 3 seconds
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 3000);

                return;
            }

            // For Expedia update handling
            if (window.ExpediapID && window.roomID) {
                // Format request for Expedia room and rate update
                const request = {
                    ExpediaID: window.ExpediaID,
                    startDate: window.startDateC.value,
                    endDate: window.endDateC.value,
                    price: window.roomP.value,
                    roomNum: window.roomN.value,
                    roomID: window.roomID,  // Pass the actual roomID (e.g., 325697395)
                    ratePlanID: window.ExpediapID, // Pass the ratePlanID separately
                    roomTypeName: window.roomTypeName,
                    ratePlanName: window.ratePlanName || "Standard Rate"
                };

                console.log("Sending Expedia update request:", request);
                sendMessage('updateExpediaRoomAndRate', request);

                // Close the modal after sending the request
                const modalElement = document.getElementById('modal-form');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }

                // Add a temporary success message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'alert alert-info';
                messageDiv.style.position = 'fixed';
                messageDiv.style.top = '20px';
                messageDiv.style.left = '50%';
                messageDiv.style.transform = 'translateX(-50%)';
                messageDiv.style.zIndex = '9999';
                messageDiv.innerHTML = `Updating Expedia room ${window.roomID} and rate plan ${window.ExpediapID} from ${window.startDateC.value} to ${window.endDateC.value}...`;
                document.body.appendChild(messageDiv);

                // Remove the message after 3 seconds
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 3000);

                return;
            }

            // For other hotel types
            sendMessage('updatePrice', {
                hotel_id: window.bookingID,
                ctripID: window.ctripID,
                room_id: window.room_id,
                room_id_ctrip: window.room_id_ctrip,
                room_id_expediap: 325405295,
                rate_id: window.rate_id,
                field_value: window.roomP.value,
                from_date: window.startDateC.value,
                until_date: window.endDateC.value,
                occupancy: window.occupancy,
                roomNum: window.roomN.value,
                basicRoomId: window.basicRoomId,
                person: window.person,
                roomID: window.roomID,
                cipher: cipher,
                roomTypeId: window.roomTypeId,
                AgodaHotelID: window.AgodaHotelID,
                AgodaHotelRoomID: window.AgodaHotelRoomID,
                AgodaDmcId: window.AgodaDmcId,
                RateCategoryID: window.RateCategoryID,
                ExpediapID: window.ExpediapID,
                ExpediapHtid: window.ExpediaID
            })
        }

        // 获取房间数据
        const myHeaders = new Headers();
        myHeaders.append("content-type", "application/json");

        const requestOptions = {
            method: "GET",
            headers: myHeaders,
            redirect: "follow"
        };

        fetch("https://cunchu.site/work/storage/appartment/room.json", requestOptions)
            .then((response) => response.json())
            .then((result) => {
                window.bookingID = result[getQueryParam('hotelID')].Booking[0]
                window.ctripID = result[getQueryParam('hotelID')].Trip[0]
                window.AgodaHotelID = result[getQueryParam('hotelID')]["Agoda Hotel"]
                // window.AgodaHomesID= result[getQueryParam('hotelID')]["Agoda Homes"]
                window.AgodaHomesID = result[getQueryParam('hotelID')]["Agoda homes upc"][0]
                window.ExpediaID = result[getQueryParam('hotelID')]["Expedia"][0]
                // booking
                // sendMessage('getInventory', {
                //     page: nowPage - 1,
                //     hotelID: bookingID,
                //     ebooking: window.ctripID,
                //     AgodaHotelID: window.AgodaHotelID,
                //     ExpediaID: window.ExpediaID,
                //     // AgodaHomesID: window.AgodaHomesID,
                //     // AgodaHomesUpcID: window.AgodaHomesUpcID,
                //     start: getQueryParam('start') ? getQueryParam('start') : getDateNDaysAgo(0),
                //     end: getQueryParam('end') ? getQueryParam('end') : getDateNDaysAgo(31),
                // })

                // Send request for Agoda Hotel data
                if (window.AgodaHotelId) {
                    sendMessage('getInventoryAgodaHotel', {
                        AgodaHotelID: window.AgodaHotelID,
                        start: getQueryParam('start') ? formatDateForAgoda(getQueryParam('start')) : formatDateForAgoda(getDateNDaysAgo(0)),
                        end: getQueryParam('end') ? formatDateForAgoda(getQueryParam('end')) : formatDateForAgoda(getDateNDaysAgo(31)),
                        getAllDates: true  // Add a flag to indicate we want all dates
                    })
                }

                // Send request for Ctrip data
                if (window.ctripID) {
                    sendMessage('getInventoryCtrip', {
                        hotelId: window.ctripID,
                        startDate: getQueryParam('start') ? getQueryParam('start') : getDateNDaysAgo(0),
                        endDate: getQueryParam('end') ? getQueryParam('end') : getDateNDaysAgo(31)
                    })
                }

                // Send request for Expedia rate plans
                if (window.ExpediaID) {
                    sendMessage('getRatePlans', {
                        ExpediaID: window.ExpediaID,
                        start: getQueryParam('start') ? getQueryParam('start') : getDateNDaysAgo(0),
                        end: getQueryParam('end') ? getQueryParam('end') : getDateNDaysAgo(31)
                    })
                }

                // Send request for Booking inventory
                if (window.bookingID) {
                    sendMessage('inventoryBooking', {
                        hotelID: window.bookingID,
                        startDate: getQueryParam('start') ? getQueryParam('start') : getDateNDaysAgo(0),
                        endDate: getQueryParam('end') ? getQueryParam('end') : getDateNDaysAgo(31)
                    })
                }
            })
            .catch((error) => console.error(error));

        // Function to properly format dates for Agoda API
        function formatDateForAgoda(dateStr) {
            // Parse the date in YYYY-MM-DD format
            const parts = dateStr.split('-');
            // Return in DD-MM-YYYY format for Agoda
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
    </script>
</body>

</html>