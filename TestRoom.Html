<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="https://cunchu.site/work/material-dashboard/assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="https://cunchu.site/work/material-dashboard/assets/img/favicon.png">
  <title>
    酒店后台管理
  </title>

  <!-- CSS Files -->
  <link id="pagestyle" href="https://cunchu.site/work/material-dashboard/assets/css/material-dashboard.css?v=3.2.0" rel="stylesheet" />
  <style>
  </style>
</head>

<body class="g-sidenav-show  bg-gray-100">
  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">

    <!-- 日期搜索框 -->
    <div class="container" style="height: 40px;">
      <div class="row" style=" display: flex; justify-content: end; ">
        <div class="col-md-2">
          <div class="input-group input-group-static">
            <input type="date" id="startDate" class="form-control input-item-1">
          </div>
        </div>
        <div class="col-md-2">
          <div class="input-group input-group-static">
            <input type="date" id="endDate" class="form-control input-item-2">
          </div>
        </div>
        <div class="col-md-2">
          <div class="input-group input-group-outline">
            <label class="form-label">关键词</label>
            <input type="text" id="propertyId" class="form-control input-item-3">
          </div>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn bg-gradient-info" onclick="search()">搜索</button>
        </div>
      </div>
    </div>


    <div class="container-box container-fluid py-2">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body px-0 pb-2">
              <div class="table-responsive p-0">
                <table class="table align-items-center justify-content-center mb-0">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">住宿ID</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">客人姓名</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">入住</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">退房</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">状态</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">房型</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">房间数</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">手机号</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">总房费</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">佣金</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">实际收款</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">预订编号</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">预订日期</th>
                    </tr>
                  </thead>
                  <tbody id="graphqlTable">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
      <!-- 分页 -->
      <nav aria-label="Page navigation example">
        <ul class="pagination">
          <!-- Phan trang dong -->
        </ul>
      </nav>
    </div>

  <!--   Core JS Files   -->
  <script src="https://cunchu.site/work/material-dashboard/assets/js/core/bootstrap.min.js"></script>
  <script src="./main.js"></script> 
  <script>
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param) ? urlParams.get(param) : '';
    }

    function getTimestampSeconds (str) {
       if (str == null) return ''; 

      const dateMatch = str.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);

      if (dateMatch) {
          const year = parseInt(dateMatch[1]);
          const month = parseInt(dateMatch[2]) - 1; 
          const day = parseInt(dateMatch[3]);
          const date = new Date(Date.UTC(year, month, day)); 
          if (!isNaN(date.getTime())) {
             return Math.floor(date.getTime() / 1000);
          } else {
              console.warn("Ngày không hợp lệ sau khi phân tích (年/月/日):", str);
              return '';
          }
      } else {

        const isoDateMatch = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
          if(isoDateMatch) {
              const year = parseInt(isoDateMatch[1]);
              const month = parseInt(isoDateMatch[2]) - 1;
              const day = parseInt(isoDateMatch[3]);
              const date = new Date(Date.UTC(year, month, day)); // Sử dụng UTC
              if (!isNaN(date.getTime())) {
                  return Math.floor(date.getTime() / 1000);
              } else {
                 console.warn("Ngày không hợp lệ sau khi phân tích (YYYY-MM-DD):", str);
                 return '';
              }
          } else {
             return '';
          }
      }
    }

    function sendMessage (type, data) {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: type, data: data }, '*');
      } else {
        console.warn("Không thể gửi tin nhắn: không tìm thấy cửa sổ cha.");
      }
    }

    const nowPage = getQueryParam('page') ? parseInt(getQueryParam('page'), 10) : 1;

    window.addEventListener('message', function(event) {
      const meg = event.data;
      if (!meg || typeof meg !== 'object' || !meg.type || !meg.value) {
          return;
      }

      switch (meg.type) {
        case "searchReservations":
          let tempData = ``;
          let roomList = [];

          if (!Array.isArray(meg.value.reservations)) {
              console.error('Dữ liệu reservations không phải là một mảng:', meg.value.reservations);
              window.graphqlTable.innerHTML = `<tr><td colspan="14">Lỗi tải dữ liệu đặt phòng.</td></tr>`; // Colspan = 14
              return;
          }

          if (meg.value.reservations.length === 0) {
             tempData = `<tr><td colspan="14" class="text-center">没有找到适用的预订 (Không tìm thấy đặt phòng nào).</td></tr>`; // Colspan = 14
          } else {
             for (let index = 0; index < meg.value.reservations.length; index++) {
                const element = meg.value.reservations[index];

                // Bỏ qua nếu element không hợp lệ
                if (!element || typeof element !== 'object') continue;

                // Thêm ID hợp lệ vào danh sách
                if (element.id != null) {
                  roomList.push(element.id);
                }

                // ----- TÍNH TOÁN SỐ TIỀN THỰC NHẬN -----
                const rawTotalAmount = element.amountInvoicedOrRoomPriceSum ?? 0;
                const rawCommission = element.actualCommissionRaw ?? 0;

                // Chuyển đổi sang số một cách an toàn
                const totalAmount = Number(rawTotalAmount);
                const commission = Number(rawCommission);

                let netAmountDisplay = 'N/A'; // Mặc định là N/A

                if (!isNaN(totalAmount)) { // Chỉ tính khi tổng tiền là số hợp lệ
                    if (isNaN(commission)) { // Nếu hoa hồng không phải số
                        netAmountDisplay = totalAmount.toFixed(2); // Thực nhận bằng tổng tiền
                    } else { // Nếu cả hai đều là số hợp lệ
                        const netAmount = totalAmount - commission;
                        netAmountDisplay = netAmount.toFixed(2); // Tính và định dạng
                    }
                }

                tempData += `<tr>
                  <td><p class="text-sm font-weight-bold mb-0">${element.propertyId ?? ''}</p></td>
                  <td><p class="text-sm font-weight-bold mb-0">${element.bookerFirstName ?? ''} ${element.bookerLastName ?? ''}</p></td>
                  <td><p class="text-sm font-weight-bold mb-0">${element.checkin ?? ''}</p></td>
                  <td><p class="text-sm font-weight-bold mb-0">${element.checkout ?? ''}</p></td>
                  <td><p class="text-sm font-weight-bold mb-0">${element.aggregatedRoomStatus === 'ok' ? '正常' : (element.aggregatedRoomStatus ? '已取消' : 'N/A')}</p></td>
                  <td><p class="text-sm font-weight-bold mb-0 room_info_${element.id ?? ''}"></p></td>
                  <td><p class="text-sm font-weight-bold mb-0 num_rooms_${element.id ?? ''}"></p></td>
                  <td><p class="text-sm font-weight-bold mb-0 room_phone_${element.id ?? ''}"></p></td>
                  <td><p class="text-sm font-weight-bold mb-0">${rawTotalAmount}</p></td> {/* Giữ giá trị gốc */}
                  <td><p class="text-sm font-weight-bold mb-0">${rawCommission}</p></td> {/* Giữ giá trị gốc */}
                  {/* ----- Ô DỮ LIỆU MỚI ----- */}
                  <td><p class="text-sm font-weight-bold mb-0">${netAmountDisplay}</p></td>
                  {/* ----------------------- */}
                  <td><p class="text-sm font-weight-bold mb-0 n_check n_check_${element.id ?? ''}" onclick="getReservationDetails(${element.id ?? null}, ${element.propertyId ?? null})">${element.id ?? 'N/A'}</p></td>
                  <td><p class="text-sm font-weight-bold mb-0">${(element.createdAt ?? '').split(' ')[0]}</p></td>
                </tr>`;
             }
          } 

          window.graphqlTable.innerHTML = tempData;

          if (roomList.length > 0 && typeof getNewData === 'function') {
            getNewData(roomList);
          }
          if (typeof creatPage === 'function') {
             creatPage(meg.value.totalRecords ?? 0, 100);
          } else {
             console.warn('Hàm creatPage không được định nghĩa.');
          }

          break; 

        case "reservationDetails":
          if (!meg.value || meg.value.id == null) {
              console.error('Dữ liệu reservationDetails không hợp lệ hoặc thiếu ID:', meg.value);
              return;
          }

          const resId = meg.value.id;

          const roomInfoEl = document.querySelector(`.room_info_${resId}`);
          const numRoomsEl = document.querySelector(`.num_rooms_${resId}`);
          const phoneEl = document.querySelector(`.room_phone_${resId}`);
          const checkEl = document.querySelector(`.n_check_${resId}`);

          const roomInfo = Array.isArray(meg.value.room_info) ? meg.value.room_info.join('<br>') : (meg.value.room_info ?? '');
          const roomNum = meg.value.num_rooms ? Number(meg.value.num_rooms) : 0;
          const phone = meg.value.phone ?? '';
          const transactionDate = meg.value.transaction_date ?? '';
          const arrivalDate = meg.value.arrival ?? '';
          const departureDate = meg.value.departure ?? '';
          const priceArr = (meg.value.price ?? ' ').split(' ');
          const price = priceArr.length > 1 ? priceArr[1] : ''; 
          const guestName = meg.value.guest_name ?? '';
          const hotelId = meg.value.hotel_id ?? null;
          const isCancelled = meg.value.is_cancelled ?? 1; 
          const status = isCancelled == 0 ? 'Confirmed' : 'Cancelled'; 

          if (roomInfoEl) roomInfoEl.innerHTML = roomInfo;
          if (numRoomsEl) numRoomsEl.innerText = roomNum;
          if (phoneEl) phoneEl.innerText = phone;

          if (typeof addRoom === 'function') {
              addRoom(
                  resId, "Booking", phone, roomNum, 0.00, roomInfo,
                  getTimestampSeconds(transactionDate), getTimestampSeconds(arrivalDate), getTimestampSeconds(departureDate),
                  price, guestName, hotelId, status
              );
          } else {
              console.warn('Hàm addRoom không được định nghĩa.');
          }

          if (checkEl) {
            checkEl.classList.remove('n_check');
          }
          break; // Kết thúc case "reservationDetails"

        default:
          break;
      }
    });

    // Gửi yêu cầu dữ liệu ban đầu
    sendMessage('getSearchReservations', {
      page: nowPage - 1,
      propertyId: getQueryParam('propertyId'),
      start:  getQueryParam('start') || getDateNDaysAgo(0),
      end:  getQueryParam('end') || getDateNDaysAgo(30),
    });

    // Tự động làm mới
    let refreshInterval = setInterval(() => {
      sendMessage('getSearchReservations', {
        page: nowPage - 1,
        propertyId: getQueryParam('propertyId'), // Giữ bộ lọc từ URL
        start:  window.startDate.value, // Lấy giá trị hiện tại
        end:  window.endDate.value,     // Lấy giá trị hiện tại
      });
    }, 16000); // 16 giây

    function search () {
      clearInterval(refreshInterval); // Xóa interval cũ

      location.href = `./room.html?propertyId=${window.propertyId.value}&start=${window.startDate.value}&end=${window.endDate.value}&page=1`;
    }

    function getDateNDaysAgo (n) {
      const date = new Date();
      date.setDate(date.getDate() + n);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function getReservationDetails (book_id, hotel_id) {
       if (book_id == null || hotel_id == null) {
           console.error("Không thể lấy chi tiết: book_id hoặc hotel_id là null.");
           return;
       }
       if (document.querySelector(`.n_check_${book_id}`)) {
          sendMessage('getReservationDetails', {book_id, hotel_id});
       }
    }

    window.startDate.value = getQueryParam('start') || getDateNDaysAgo(0);
    window.endDate.value = getQueryParam('end') || getDateNDaysAgo(30);
    window.propertyId.value = getQueryParam('propertyId');

    function getNewData (roomList) {
      if (!Array.isArray(roomList) || roomList.length === 0) return;

      const myHeaders = new Headers();
      myHeaders.append("Content-Type", "application/json");

      const validRoomList = roomList.filter(id => id != null); 
      if (validRoomList.length === 0) return;

      const raw = JSON.stringify({ "orderID": validRoomList.join(',') });

      const requestOptions = { method: "POST", headers: myHeaders, body: raw, redirect: "follow" };

      fetch("https://1256763111-f2tvymu35g.ap-beijing.tencentscf.com/selectRoom", requestOptions)
        .then((response) => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then((result) => {
          if (!Array.isArray(result)) {
              console.error("Kết quả từ selectRoom không phải là mảng:", result);
              return;
          }
          result.forEach(element => {
            if (Array.isArray(element) && element.length > 0 && element[0] != null) {
                const resId = element[0];
                const roomInfoEl = document.querySelector(`.room_info_${resId}`);
                const numRoomsEl = document.querySelector(`.num_rooms_${resId}`);
                const phoneEl = document.querySelector(`.room_phone_${resId}`);
                const checkEl = document.querySelector(`.n_check_${resId}`);

                if (checkEl) { 
                    if (roomInfoEl && element[5] !== undefined) roomInfoEl.innerHTML = element[5];
                    if (numRoomsEl && element[3] !== undefined) numRoomsEl.innerText = element[3];
                    if (phoneEl && element[2] !== undefined) phoneEl.innerText = element[2];
                    checkEl.classList.remove('n_check');
                }
            }
          });

          setTimeout(() => {
            const firstUnchecked = document.querySelector('.n_check');
            if (firstUnchecked) { firstUnchecked.click(); }
          }, 1000);
        })
        .catch((error) => console.error("Lỗi khi gọi getNewData (selectRoom):", error));
    }

  </script>
</body>

</html>